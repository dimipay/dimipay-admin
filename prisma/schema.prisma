generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["referentialIntegrity"]
}

datasource db {
  provider             = "mysql"
  url                  = env("DATABASE_URL")
  referentialIntegrity = "prisma"
}

model User {
  id                  String          @id @default(uuid())
  systemId            String          @unique
  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @default(now()) @updatedAt
  isDisabled          Boolean         @default(false)
  accountName         String          @unique
  name                String
  isTeacher           Boolean?        @default(false)
  profileImage        String?
  studentNumber       String?
  relatedAdminAccount AdminAccount?
  transactions        Transaction[]
  issuedCoupons       Coupon[]        @relation("issue")
  receivedCoupons     Coupon[]        @relation("receive")
  paymentMethods      PaymentMethod[]
  paymentPin          String?
  phoneNumber         String?
  notice              Notice[]
}

model PaymentMethod {
  id          String            @id @default(uuid())
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now()) @updatedAt
  type        PaymentMethodType
  color       String?
  name        String?
  generalCard GeneralCard?      @relation("generalCard")
  prepaidCard PrepaidCard?      @relation("prepaidCard")
  owner       User              @relation(fields: [ownerId], references: [systemId])
  ownerId     String
  transaction Transaction[]
}

model PrepaidCard {
  id                       String                     @id @default(uuid())
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @default(now()) @updatedAt
  balance                  Int                        @default(0)
  paymentMethodId          String                     @unique
  paymentMethod            PaymentMethod              @relation("prepaidCard", fields: [paymentMethodId], references: [id])
  prepaidCardChargeHistory PrepaidCardChargeHistory[]
}

model PrepaidCardChargeHistory {
  id                  String            @id @default(uuid())
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @default(now()) @updatedAt
  delta               Int
  status              TransactionStatus
  method              String
  detailInfo          String
  targetPrepaidCardId String
  prepaidCard         PrepaidCard       @relation(fields: [targetPrepaidCardId], references: [id])
}

model GeneralCard {
  id              String        @id @default(uuid())
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now()) @updatedAt
  cardNumber      String
  validMonth      Int
  validYear       Int
  billingKey      String
  paymentMethodId String        @unique
  paymentMethod   PaymentMethod @relation("generalCard", fields: [paymentMethodId], references: [id])
}

model Coupon {
  id                String       @id @default(uuid())
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @default(now()) @updatedAt
  name              String
  expiresAt         DateTime?
  amount            Int
  usedTransactionId String?
  issuerId          String
  issuer            User         @relation("issue", fields: [issuerId], references: [systemId])
  receiver          User         @relation("receive", fields: [receiverId], references: [systemId])
  receiverId        String
  transaction       Transaction? @relation(fields: [usedTransactionId], references: [id])
}

model Transaction {
  id            String                 @id @default(uuid())
  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @default(now()) @updatedAt
  billingId     String
  totalPrice    Int
  status        Transaction_status
  statusText    String?
  authMethod    Transaction_authMethod
  usedCardId    String
  posDeviceId   String
  userId        String
  user          User                   @relation(fields: [userId], references: [systemId])
  posDevice     PosDevice              @relation(fields: [posDeviceId], references: [id])
  paymentMethod PaymentMethod          @relation(fields: [usedCardId], references: [id])
  coupon        Coupon[]
  products      Product[]
}

model Category {
  id               String           @id @default(uuid())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @default(now()) @updatedAt
  name             String
  color            String
  discountPolicyId String?
  products         Product[]
  discountPolicy   DiscountPolicy[]
}

model Product {
  id                      String            @id @default(uuid())
  createdAt               DateTime          @default(now())
  updatedAt               DateTime          @default(now()) @updatedAt
  name                    String
  barcode                 String?
  price                   Int
  sellingStopped          Boolean           @default(false)
  categoryId              String
  category                Category          @relation(fields: [categoryId], references: [id])
  productInOutLog         ProductInOutLog[]
  transaction             Transaction[]
  excludedDiscountPolicy  DiscountPolicy[]  @relation("discountExcludedProduct")
  targettedDiscountPolicy DiscountPolicy[]  @relation("discountTargetProduct")
}

model ProductInOutLog {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  delta     Int
  message   String?
  productId String
  product   Product  @relation(fields: [productId], references: [id])
}

model DiscountPolicy {
  id              String     @id @default(uuid())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @default(now())
  fixedPrice      Int?
  percentRate     Int?
  eventId         String?
  relatedEvent    Event?     @relation(fields: [eventId], references: [id])
  targetCategory  Category[]
  excludedProduct Product[]  @relation("discountExcludedProduct")
  targetProduct   Product[]  @relation("discountTargetProduct")
}

model PosDevice {
  id          String        @id @default(uuid())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @default(now())
  name        String
  disabled    Boolean       @default(false)
  transaction Transaction[]
}

model Event {
  id               String           @id @default(uuid())
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @default(now())
  startsAt         DateTime?
  endsAt           DateTime?
  title            String
  description      String
  url              String
  discountPolicies DiscountPolicy[]
}

model Notice {
  id          String    @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @default(now())
  startsAt    DateTime  @default(now())
  endsAt      DateTime?
  title       String
  description String?
  url         String?
  authorId    String
  author      User      @relation(fields: [authorId], references: [systemId])
}

model AdminAccount {
  id                   String   @id @default(uuid())
  createdAt            DateTime @default(now())
  updatedAt            DateTime @default(now())
  relatedUser          User?    @relation(fields: [relatedUserSystemUid], references: [systemId])
  relatedUserSystemUid String?  @unique
  username             String
  hashedPassword       String
  description          String?
}

model CategoryToDiscountPolicy {
  A String
  B String

  @@unique([A, B], map: "_CategoryToDiscountPolicy_AB_unique")
  @@index([B], map: "_CategoryToDiscountPolicy_B_index")
  @@map("_CategoryToDiscountPolicy")
}

model ProductToTransaction {
  A String
  B String

  @@unique([A, B], map: "_ProductToTransaction_AB_unique")
  @@index([B], map: "_ProductToTransaction_B_index")
  @@map("_ProductToTransaction")
}

model discountExcludedProduct {
  A String
  B String

  @@unique([A, B], map: "_discountExcludedProduct_AB_unique")
  @@index([B], map: "_discountExcludedProduct_B_index")
  @@map("_discountExcludedProduct")
}

model discountTargetProduct {
  A String
  B String

  @@unique([A, B], map: "_discountTargetProduct_AB_unique")
  @@index([B], map: "_discountTargetProduct_B_index")
  @@map("_discountTargetProduct")
}

enum PaymentMethodType {
  PREPAID
  GENERAL
}

enum TransactionStatus {
  CONFIRMED
  CANCELED
  ERROR
}

enum Transaction_status {
  CONFIRMED
  CANCELED
  ERROR
}

enum Transaction_authMethod {
  SMS
  APP_QR
  FACESIGN
}
